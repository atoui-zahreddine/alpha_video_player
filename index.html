<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TS Video Player</title>
    <link href="https://vjs.zencdn.net/7.15.4/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.15.4/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js/dist/mpegts.js"></script>
  </head>
  <body>
    <input
      type="text"
      id="video-url"
      placeholder="Enter video URL (MP2T)"
      style="width: 80%"
    />
    <button onclick="playVideo()">Play Video</button>

    <video
      id="video-player"
      class="video-js vjs-default-skin"
      controls
      autoplay
      preload="auto"
      width="640"
      height="360"
    ></video>

    <script>
      let currentPlayer = null;
      let videoJsPlayer = null;

      async function cleanupPlayer() {
        if (currentPlayer) {
          try {
            await currentPlayer.pause();
            await currentPlayer.unload();
            currentPlayer.destroy();
            currentPlayer = null;
          } catch (error) {
            console.error("Cleanup error:", error);
          }
        }

        if (videoJsPlayer) {
          videoJsPlayer.reset();
        }
      }

      async function playVideo() {
        await cleanupPlayer();

        const videoUrl = document.getElementById("video-url").value;

        // Initialize video.js player if not already done
        if (!videoJsPlayer) {
          videoJsPlayer = videojs("video-player", {
            techOrder: ["html5"],
            autoplay: true,
            controls: true,
          });
        }

        if (window.mpegts) {
          const mpegts = window.mpegts;
          if (mpegts.getFeatureList().mseLivePlayback) {
            const player = mpegts.createPlayer({
              type: "mpegts",
              url: videoUrl,
              isLive: true,
              liveBufferLatencyChasing: true,
            });

            currentPlayer = player;

            // Get the raw video element from video.js
            const videoElement = document.getElementById(
              "video-player_html5_api"
            );

            // Attach to the raw video element
            player.attachMediaElement(videoElement);

            // Enhanced error handling
            player.on("error", function (e) {
              console.error("Player error:", e);
              setTimeout(async () => {
                await cleanupPlayer();
                await playVideo();
              }, 3000);
            });

            player.on("loading_complete", function () {
              console.log("Loading completed");
            });

            player.load();
            player.play();
          } else {
            alert("MPEG-TS live streaming is not supported in this browser.");
          }
        } else {
          alert("MPEGTS.js is not loaded.");
        }
      }
    </script>
  </body>
</html>
