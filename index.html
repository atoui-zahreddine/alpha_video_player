<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TS Video Player</title>
    <link href="https://vjs.zencdn.net/7.15.4/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.15.4/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js/dist/mpegts.js"></script>
  </head>
  <body>
    <input
      type="text"
      id="video-url"
      placeholder="Enter video URL (MP2T)"
      style="width: 80%"
    />
    <button onclick="playVideo()">Play Video</button>

    <video
      id="video-player"
      class="video-js vjs-default-skin"
      controls
      autoplay
      preload="auto"
      width="640"
      height="360"
    ></video>

    <script>
      const { ipcRenderer } = require('electron');

      function playVideo() {
        const videoUrl = document.getElementById("video-url").value;
        const videoPlayer = videojs("video-player");

        if (window.mpegts) {
          const mpegts = window.mpegts;
          if (mpegts.getFeatureList().mseLivePlayback) {
            const player = mpegts.createPlayer({
              type: "mpegts",
              url: videoUrl,
              isLive: true,
              liveBufferLatencyChasing: true,
              liveSync: true,
              liveSyncLatencyMax: 1.5,
              lazyLoad: false,
              fixAudioTimestampGap: true,
              customLoader: {
                load: async function(context, config) {
                  try {
                    const response = await ipcRenderer.invoke('proxy-request', { 
                      url: context.url,
                      isLive: true 
                    });
                    
                    if (response.status === 200) {
                      context.onSuccess(response.status, response.headers, response.data);
                    } else {
                      context.onError({
                        code: response.status,
                        msg: `HTTP Error: ${response.status}`
                      });
                    }
                  } catch (error) {
                    context.onError({
                      code: -1,
                      msg: error.message
                    });
                  }
                },
                abort: function() {
                  // Implement proper abort handling for live streams
                  console.log("Stream aborted");
                }
              }
            });

            player.attachMediaElement(
              document.getElementById("video-player_html5_api")
            );

            // Enhanced error handling
            player.on("error", function (e) {
              console.error("Player error:", e);
              setTimeout(() => {
                player.unload();
                player.load();
                player.play();
              }, 3000);
            });

            player.on("loading_complete", function () {
              console.log("Loading completed");
            });

            player.on("statistics_info", function (stats) {
              console.log("Buffer size:", stats.videoBufferSize);
              console.log("Current speed:", stats.currentKbps, "kbps");
            });

            // Add live stream specific event handlers
            player.on('statistics_info', function(stats) {
              if (stats.totalBytes > 0) {
                const currentLatency = stats.currentLatency || 0;
                if (currentLatency > 3) {
                  // Try to catch up if we're falling behind
                  player.currentTime = player.buffered.end(0) - 1;
                }
              }
            });

            player.on('loading_complete', function() {
              console.log('Stream connected');
            });

            // Add automatic reconnection
            player.on('error', function(e) {
              console.error('Player error:', e);
              // More aggressive reconnection for live streams
              setTimeout(() => {
                player.unload();
                player.load();
                player.play();
              }, 1000);
            });

            player.load();
            player.play();
          } else {
            alert("MPEG-TS live streaming is not supported in this browser.");
          }
        } else {
          alert("MPEGTS.js is not loaded.");
        }
      }
    </script>
  </body>
</html>
